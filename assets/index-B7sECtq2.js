var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,l=(t,s,n)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n,o=(e,t,s)=>l(e,"symbol"!=typeof t?t+"":t,s);import{d as r,a as c,c as u,aA as m,o as d,e as h,f as p,h as v,p as f,z as b,m as g,u as x,l as y,az as T,y as w,k as _,G as j,H as C,w as S,N as k}from"./index-DuNn1tT0.js";import{E}from"./el-alert-CPaLutD1.js";import{E as O}from"./el-empty-BdMhBNuP.js";/* empty css               */import{E as I,a as N}from"./el-option-HDUlhA_A.js";/* empty css                  *//* empty css                     *//* empty css                  */import{E as R,a as W}from"./el-form-item-DKoSTcyf.js";import{E as A}from"./el-button-Cu-8GITI.js";import{E as P}from"./el-space-f5l4qICp.js";/* empty css                    *//* empty css                 */import{E as V}from"./el-row-BI0QOwqJ.js";import{E as H}from"./el-col-D_v_uR8c.js";import{E as Q}from"./el-card-DUwWYAzT.js";/* empty css                */import{E as z}from"./index-BHP5EuW7.js";import{E as L}from"./index-DKGOt7-B.js";import{E as M}from"./index-Dwe9iiwQ.js";import{_ as $}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./index-BICMxtfg.js";import"./index-CSnsSW2Y.js";import"./index-Cwozh5L4.js";import"./aria-Dle50h-X.js";import"./index-B54hCvU_.js";import"./use-form-common-props-YkJZMUeo.js";import"./index-DM4EDxAy.js";import"./token-DWNpOE8r.js";import"./strings-DrkoAcI2.js";import"./castArray-CK2YYBjI.js";import"./index-Qk1PgHVU.js";import"./event-BwRzfsZt.js";import"./scroll-C6vSq5CK.js";import"./debounce-CaRH_5Ar.js";import"./toNumber-U8DKyFfl.js";import"./_baseIteratee-Bx0whLuV.js";import"./index-CaqOoRuI.js";import"./vnode-Cc9CZV6n.js";import"./_baseClone-lawoqp3c.js";import"./_initCloneObject-DfdnlAFm.js";import"./index-I47MLRFf.js";var D={};const G=class e{constructor(e){o(this,"ws",null),o(this,"url"),o(this,"messageHandler"),o(this,"reconnectInterval"),o(this,"heartbeatInterval"),o(this,"pingInterval"),o(this,"reconnectTimeout"),o(this,"maxReconnectAttempts"),o(this,"connectionTimeout"),o(this,"reconnectAttempts",0),o(this,"messageQueue",[]),o(this,"detectionTimer",null),o(this,"timeoutTimer",null),o(this,"reconnectTimer",null),o(this,"pingTimer",null),o(this,"connectionTimer",null),o(this,"isConnected",!1),o(this,"isConnecting",!1),o(this,"stopReconnect",!1),this.url=e.url||D.VUE_APP_LOGIN_WEBSOCKET,this.messageHandler=e.messageHandler,this.reconnectInterval=e.reconnectInterval||2e4,this.heartbeatInterval=e.heartbeatInterval||5e3,this.pingInterval=e.pingInterval||1e4,this.reconnectTimeout=e.reconnectTimeout||3e4,this.maxReconnectAttempts=e.maxReconnectAttempts||10,this.connectionTimeout=e.connectionTimeout||1e4}static getInstance(t){return e.instance?(e.instance.messageHandler=t.messageHandler,t.url&&e.instance.url!==t.url&&(e.instance.url=t.url,e.instance.reconnectAttempts=0,e.instance.init())):e.instance=new e(t),e.instance}init(){var e;if(!this.isConnecting)if((null==(e=this.ws)?void 0:e.readyState)!==WebSocket.OPEN)try{this.isConnecting=!0,this.reconnectAttempts=0,this.ws=new WebSocket(this.url),this.clearTimer("connectionTimer"),this.connectionTimer=setTimeout(()=>{this.handleConnectionTimeout()},this.connectionTimeout),this.ws.onopen=e=>this.handleOpen(e),this.ws.onmessage=e=>this.handleMessage(e),this.ws.onclose=e=>this.handleClose(e),this.ws.onerror=e=>this.handleError(e)}catch(t){this.isConnecting=!1,this.reconnect()}else this.flushMessageQueue()}handleConnectionTimeout(){var e,t;(null==(e=this.ws)?void 0:e.readyState)!==WebSocket.OPEN&&(null==(t=this.ws)||t.close(1e3,"Connection timeout"),this.isConnecting=!1,this.reconnect())}close(e){this.clearAllTimers(),this.stopReconnect=!0,this.isConnecting=!1,this.ws&&(this.ws.close(e?1001:1e3,e?"Force closed":"Normal close"),this.ws=null),this.isConnected=!1}send(e,t=!1){if(!t||this.ws&&this.ws.readyState===WebSocket.OPEN){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return this.messageQueue.push(e),void(this.isConnecting||this.stopReconnect||this.init());try{this.ws.send(e)}catch(s){this.messageQueue.push(e),this.reconnect()}}}flushMessageQueue(){var e,t;if(this.messageQueue.length>0&&(null==(e=this.ws)?void 0:e.readyState)===WebSocket.OPEN)for(;this.messageQueue.length>0;){const e=this.messageQueue.shift();if(e)try{null==(t=this.ws)||t.send(e)}catch(s){e&&this.messageQueue.unshift(e);break}}}handleOpen(e){this.clearTimer("connectionTimer"),this.isConnected=!0,this.isConnecting=!1,this.stopReconnect=!1,this.reconnectAttempts=0,this.startHeartbeat(),this.startPing(),this.flushMessageQueue()}handleMessage(e){this.resetHeartbeat(),this.messageHandler(e)}handleClose(e){const t=1e3===e.code;this.isConnected=!1,this.isConnecting=!1,this.clearAllTimers(),this.stopReconnect||t||this.reconnect()}handleError(e){this.isConnected=!1,this.isConnecting=!1,this.stopReconnect||this.reconnect()}getReadyStateText(e){switch(e){case WebSocket.CONNECTING:return"CONNECTING (0) - 正在连接";case WebSocket.OPEN:return"OPEN (1) - 已连接";case WebSocket.CLOSING:return"CLOSING (2) - 正在关闭";case WebSocket.CLOSED:return"CLOSED (3) - 已关闭";default:return`未知状态 (${e})`}}startHeartbeat(){this.clearTimer("detectionTimer"),this.clearTimer("timeoutTimer"),this.detectionTimer=setTimeout(()=>{var e;this.isConnected=(null==(e=this.ws)?void 0:e.readyState)===WebSocket.OPEN,this.isConnected||(this.reconnect(),this.timeoutTimer=setTimeout(()=>{this.close()},this.reconnectTimeout))},this.heartbeatInterval)}resetHeartbeat(){this.clearTimer("detectionTimer"),this.clearTimer("timeoutTimer"),this.startHeartbeat()}startPing(){this.clearTimer("pingTimer"),this.pingTimer=setInterval(()=>{var e;if((null==(e=this.ws)?void 0:e.readyState)!==WebSocket.OPEN)return this.clearTimer("pingTimer"),void this.reconnect();try{this.ws.send("ping")}catch(t){this.clearTimer("pingTimer"),this.reconnect()}},this.pingInterval)}reconnect(){if(this.stopReconnect||this.isConnecting)return;if(this.reconnectAttempts>=this.maxReconnectAttempts)return void this.close(!0);this.reconnectAttempts++,this.stopReconnect=!0,this.close(!0);const e=this.calculateReconnectDelay();this.clearTimer("reconnectTimer"),this.reconnectTimer=setTimeout(()=>{this.init(),this.stopReconnect=!1},e)}calculateReconnectDelay(){const e=1e3*Math.random();return Math.min(this.reconnectInterval*Math.pow(1.5,this.reconnectAttempts-1),5*this.reconnectInterval)+e}clearTimer(e){this[e]&&(clearTimeout(this[e]),this[e]=null)}clearAllTimers(){this.clearTimer("detectionTimer"),this.clearTimer("timeoutTimer"),this.clearTimer("reconnectTimer"),this.clearTimer("pingTimer"),this.clearTimer("connectionTimer")}get isWebSocketConnected(){return this.isConnected}get connectionStatusText(){return this.isConnecting?"正在连接":this.isConnected?"已连接":this.reconnectAttempts>0&&!this.stopReconnect?`重连中（${this.reconnectAttempts}/${this.maxReconnectAttempts}）`:"已断开"}static destroyInstance(){e.instance&&(e.instance.close(),e.instance=null)}};o(G,"instance",null);let U=G;const J={class:"page-content mb-5"},B={class:"text-center"},F={class:"text-2xl font-bold text-blue-500 mb-1"},K={class:"text-center"},X={class:"text-center"},Y={class:"text-2xl font-bold text-amber-500 mb-1"},Z={class:"flex items-center justify-between"},q={class:"flex items-center justify-between"},ee={class:"message-container"},te={class:"message-header"},se={class:"message-time"},ne={class:"message-content"},ie={class:"flex items-center justify-between"},ae={class:"log-container"},le={class:"flex items-start gap-2"},oe={class:"text-xs opacity-70 whitespace-nowrap"},re={class:"flex-1"},ce=r((ue=((e,t)=>{for(var s in t||(t={}))i.call(t,s)&&l(e,s,t[s]);if(n)for(var s of n(t))a.call(t,s)&&l(e,s,t[s]);return e})({},{name:"WidgetsSocketChat"}),t(ue,s({__name:"index",setup(e){const t=c(null),s=c(!1),n=c(!1),i=c(0),a=c(0);let l=null,o=null;const r=c({url:"ws://localhost:8080/ws",autoReconnect:!0,heartbeat:!0}),$=c({type:"text",content:""}),D=c([]),G=c([]),ce=u(()=>s.value?"warning":n.value?"success":"danger"),ue=(e,t)=>{G.value.unshift({type:e,message:t,time:(new Date).toLocaleTimeString()}),G.value.length>100&&(G.value=G.value.slice(0,100))},me=(e,t)=>{D.value.unshift({type:e,content:t,time:(new Date).toLocaleTimeString()}),D.value.length>50&&(D.value=D.value.slice(0,50))},de=e=>{a.value++,me("received",e.data),ue("success",`收到消息: ${e.data}`)},he=()=>{if(!s.value&&!n.value){l&&(l(),l=null),o&&(o(),o=null),s.value=!0,ue("info",`开始连接到 ${r.value.url}`);try{t.value=U.getInstance({url:r.value.url,messageHandler:de,reconnectInterval:r.value.autoReconnect?5e3:0,heartbeatInterval:r.value.heartbeat?1e4:0,maxReconnectAttempts:5}),t.value.init(),l=S(()=>{var e;return null==(e=t.value)?void 0:e.isWebSocketConnected},e=>{n.value=e||!1,s.value=!1,e&&(ue("success","WebSocket连接成功"),i.value=0)},{immediate:!0}),o=S(()=>{var e;return null==(e=t.value)?void 0:e.connectionStatusText},e=>{e&&e.includes("重连中")&&(i.value++,ue("warning",`自动重连中 (第${i.value}次)`))})}catch(e){s.value=!1;const t=e instanceof Error?e.message:String(e);ue("error",`连接失败: ${t}`),k.error("连接失败，请检查服务器地址")}}},pe=()=>{t.value&&(t.value.close(),ue("info","手动断开WebSocket连接")),l&&(l(),l=null),o&&(o(),o=null),n.value=!1,s.value=!1},ve=()=>{pe(),setTimeout(()=>{he()},1e3)},fe=()=>{if(!n.value||!t.value)return void k.warning("请先建立WebSocket连接");let e=$.value.content;switch($.value.type){case"json":try{JSON.parse(e)}catch(s){return void k.error("请输入有效的JSON格式数据")}break;case"ping":e="ping"}try{t.value.send(e),me("sent",e),ue("info",`发送消息: ${e}`),k.success("消息发送成功")}catch(i){const e=i instanceof Error?i.message:String(i);ue("error",`发送失败: ${e}`),k.error("发送消息失败")}},be=()=>{$.value.content=""},ge=()=>{D.value=[]},xe=()=>{G.value=[]};return m(()=>{pe()}),d(()=>{document.addEventListener("visibilitychange",()=>{document.hidden&&n.value&&ue("info","页面隐藏，保持连接")})}),(e,l)=>{const o=Q,c=H,u=z,m=V,d=L,S=W,k=M,U=P,ue=A,me=R,de=N,ye=I,Te=O,we=E;return p(),h("div",J,[l[23]||(l[23]=v("div",{class:"mb-15 text-center"},[v("h1",{class:"my-4 text-2xl font-semibold leading-tight"},"WebSocket 连接示例"),v("p",{class:"m-0 text-base leading-relaxed text-g-700"}," 基于 WebSocketClient 的实时通信演示，支持连接管理、消息收发和状态监控 ")],-1)),f(m,{gutter:20,class:"mb-15"},{default:b(()=>[f(c,{xs:24,sm:12,md:8},{default:b(()=>[f(o,{class:"h-full border-0","body-style":{padding:"20px"},shadow:"never"},{default:b(()=>[v("div",B,[v("div",F,g(x(a)),1),l[5]||(l[5]=v("div",{class:"text-sm font-medium text-gray-900 mb-1"},"消息统计",-1)),l[6]||(l[6]=v("div",{class:"text-xs text-gray-500"},"接收到的消息数量",-1))])]),_:1})]),_:1}),f(c,{xs:24,sm:12,md:8},{default:b(()=>[f(o,{class:"h-full border-0","body-style":{padding:"20px"},shadow:"never"},{default:b(()=>[v("div",K,[f(u,{type:x(ce),size:"large",class:"mb-2"},{default:b(()=>{var e;return[y(g((null==(e=x(t))?void 0:e.connectionStatusText)||"未连接"),1)]}),_:1},8,["type"]),l[7]||(l[7]=v("div",{class:"text-sm font-medium text-gray-900"},"连接状态",-1)),l[8]||(l[8]=v("div",{class:"text-xs text-gray-500"},"当前WebSocket连接状态",-1))])]),_:1})]),_:1}),f(c,{xs:24,sm:12,md:8},{default:b(()=>[f(o,{class:"h-full border-0","body-style":{padding:"20px"},shadow:"never"},{default:b(()=>[v("div",X,[v("div",Y,g(x(i)),1),l[9]||(l[9]=v("div",{class:"text-sm font-medium text-gray-900 mb-1"},"重连次数",-1)),l[10]||(l[10]=v("div",{class:"text-xs text-gray-500"},"自动重连尝试次数",-1))])]),_:1})]),_:1})]),_:1}),f(m,{gutter:20,class:"mb-15"},{default:b(()=>[f(c,{xs:24,md:12},{default:b(()=>[f(o,{class:"h-full border-0",shadow:"never"},{header:b(()=>[v("div",Z,[l[11]||(l[11]=v("span",{class:"text-base font-bold"},"连接配置",-1)),f(u,{type:x(ce),size:"large"},{default:b(()=>{var e;return[y(g((null==(e=x(t))?void 0:e.connectionStatusText)||"未连接"),1)]}),_:1},8,["type"])])]),default:b(()=>[f(me,{model:x(r),"label-width":"100px",class:"max-w-md"},{default:b(()=>[f(S,{label:"服务器地址"},{default:b(()=>[f(d,{modelValue:x(r).url,"onUpdate:modelValue":l[0]||(l[0]=e=>x(r).url=e),placeholder:"ws://localhost:8080/ws",clearable:""},null,8,["modelValue"])]),_:1}),f(S,{label:"连接选项"},{default:b(()=>[f(U,null,{default:b(()=>[f(k,{modelValue:x(r).autoReconnect,"onUpdate:modelValue":l[1]||(l[1]=e=>x(r).autoReconnect=e)},{default:b(()=>[...l[12]||(l[12]=[y("自动重连",-1)])]),_:1},8,["modelValue"]),f(k,{modelValue:x(r).heartbeat,"onUpdate:modelValue":l[2]||(l[2]=e=>x(r).heartbeat=e)},{default:b(()=>[...l[13]||(l[13]=[y("心跳检测",-1)])]),_:1},8,["modelValue"])]),_:1})]),_:1}),f(S,null,{default:b(()=>[f(U,null,{default:b(()=>[f(ue,{type:"primary",onClick:he,loading:x(s),disabled:x(n)},{default:b(()=>[y(g(x(s)?"连接中...":"连接"),1)]),_:1},8,["loading","disabled"]),f(ue,{type:"danger",onClick:pe,disabled:!x(n)},{default:b(()=>[...l[14]||(l[14]=[y(" 断开连接 ",-1)])]),_:1},8,["disabled"]),f(ue,{onClick:ve,disabled:x(s)},{default:b(()=>[...l[15]||(l[15]=[y("重连",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1}),f(c,{xs:24,md:12},{default:b(()=>[f(o,{class:"h-full border-0",shadow:"never"},{header:b(()=>[...l[16]||(l[16]=[v("span",{class:"text-base font-bold"},"发送消息",-1)])]),default:b(()=>[f(me,{model:x($),onSubmit:T(fe,["prevent"])},{default:b(()=>[f(S,{label:"消息类型"},{default:b(()=>[f(ye,{modelValue:x($).type,"onUpdate:modelValue":l[3]||(l[3]=e=>x($).type=e),class:"w-full"},{default:b(()=>[f(de,{label:"文本消息",value:"text"}),f(de,{label:"JSON数据",value:"json"}),f(de,{label:"心跳包",value:"ping"})]),_:1},8,["modelValue"])]),_:1}),f(S,{label:"消息内容"},{default:b(()=>[f(d,{modelValue:x($).content,"onUpdate:modelValue":l[4]||(l[4]=e=>x($).content=e),type:"textarea",rows:4,placeholder:"请输入要发送的消息内容"},null,8,["modelValue"])]),_:1}),f(S,null,{default:b(()=>[f(U,null,{default:b(()=>[f(ue,{type:"primary",onClick:fe,disabled:!x(n)||!x($).content},{default:b(()=>[...l[17]||(l[17]=[y(" 发送消息 ",-1)])]),_:1},8,["disabled"]),f(ue,{onClick:be},{default:b(()=>[...l[18]||(l[18]=[y("清空",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1})]),_:1}),f(m,{class:"mb-15"},{default:b(()=>[f(c,{span:24},{default:b(()=>[f(o,{class:"border-0",shadow:"never"},{header:b(()=>[v("div",q,[l[20]||(l[20]=v("span",{class:"text-base font-bold"},"接收消息",-1)),f(ue,{size:"small",onClick:ge},{default:b(()=>[...l[19]||(l[19]=[y("清空记录",-1)])]),_:1})])]),default:b(()=>[v("div",ee,[(p(!0),h(j,null,C(x(D),(e,t)=>(p(),h("div",{key:t,class:"message-item"},[v("div",te,[f(u,{size:"small",type:"received"===e.type?"success":"info"},{default:b(()=>[y(g("received"===e.type?"接收":"发送"),1)]),_:2},1032,["type"]),v("span",se,g(e.time),1)]),v("div",ne,g(e.content),1)]))),128)),0===x(D).length?(p(),w(Te,{key:0,description:"暂无消息记录","image-size":100})):_("",!0)])]),_:1})]),_:1})]),_:1}),f(o,{class:"border-0",shadow:"never"},{header:b(()=>[v("div",ie,[l[22]||(l[22]=v("span",{class:"text-base font-bold"},"连接日志",-1)),f(ue,{size:"small",onClick:xe},{default:b(()=>[...l[21]||(l[21]=[y("清空日志",-1)])]),_:1})])]),default:b(()=>[v("div",ae,[(p(!0),h(j,null,C(x(G),(e,t)=>(p(),w(we,{key:t,type:e.type,closable:!1,class:"!mb-2"},{title:b(()=>[v("div",le,[v("span",oe,g(e.time),1),v("span",re,g(e.message),1)])]),_:2},1032,["type"]))),128)),0===x(G).length?(p(),w(Te,{key:0,description:"暂无日志记录","image-size":100})):_("",!0)])]),_:1})])}}}))));var ue;const me=$(ce,[["__scopeId","data-v-4f037e3e"]]);export{me as default};
